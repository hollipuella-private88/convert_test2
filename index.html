<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TRPGシナリオ 変換器</title>
<style>
:root{--line:#e5e5e5;--bg:#fff;--accent:#e7f1ff;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
body{margin:0;font:15px/1.8 system-ui,"Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;background:#fafafa;color:#333}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 14px;font-weight:700}
main{padding:14px;display:grid;gap:12px;grid-template-columns:1fr}
section{background:#fff;border:1px solid var(--line);border-radius:10px; padding:12px}
h2{margin:.2em 0 .6em;font-size:1.05rem}
textarea{width:100%;min-height:42dvh;border:1px solid var(--line);border-radius:8px;padding:10px;font:13px/1.6 var(--mono);resize:vertical}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{border:1px solid var(--line);border-radius:8px;background:#fff;padding:.5em .9em;cursor:pointer}
button.primary{background:#0d6efd;border-color:#0d6efd;color:#fff}
.small{font-size:12px;color:#666}
.output{min-height:42dvh;white-space:pre;overflow:auto}
kbd{padding:.1em .4em;border:1px solid #ccc;border-bottom-width:2px;border-radius:6px;background:#f7f7f7}
@media(min-width:1100px){ main{grid-template-columns:1fr 1fr} .output{white-space:pre-wrap}}
</style>
</head>
<body>
<header>TRPGシナリオHTML変換器（ハッシュジャンプ対応）</header>
<main>
  <section>
    <h2>入力テキスト</h2>
    <p class="small">先頭2行：1) タイトル 2) 固定キー（[A-Za-z0-9_-]）。ページ見出しは <kbd>◆ info</kbd> / <kbd>◆ main</kbd> / <kbd>◆ etc</kbd>。</p>
    <textarea id="src" placeholder="ここにプレーンテキストの原稿を貼り付け"></textarea>
    <div class="controls">
      <button id="run" class="primary">変換する</button>
      <button id="copy">出力をコピー</button>
      <span class="small">強調：**太字** *斜体* __下線__ ~~取消線~~ ／ コード：```lang ... ``` or '''lang ... '''</span>
    </div>
  </section>
  <section>
    <h2>出力HTML（template.html に差し込み済み）</h2>
    <textarea id="out" class="output" readonly></textarea>
  </section>
</main>

<script>
(()=>{"use strict";

/* ===== ユーティリティ ===== */
const $=s=>document.querySelector(s);
const escapeHTML = (s)=>s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
const trimPunct = (s)=>s.replace(/[。、．，,.、。…!！?？）\)\]】」』>]+$/u,""); // 後端の句読点はジャンプ名から外す
// 安定ハッシュ（djb2）
function hashOf(s){ let h=5381; for(const ch of s){ h=((h<<5)+h) + ch.codePointAt(0); h|=0; } return (h>>>0).toString(36); }
// ID一意化ヘルパ
function uniqueId(base,taken){ let id=base; let i=2; while(taken.has(id)) id = base+"-"+(i++); taken.add(id); return id; }

/* ===== マークダウン風インライン装飾（escape 済み文字列に対して） ===== */
function inlineDecor(escaped){
  // 太字 / 斜体 / 下線 / 取り消し線（貪欲でない）
  return escaped
    .replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g,'<em>$1</em>')
    .replace(/__([^_]+)__/g,'<u>$1</u>')
    .replace(/~~([^~]+)~~/g,'<s>$1</s>');
}

/* ===== 原稿パース ===== */
function convert(raw){
  const lines = raw.replace(/\r\n?/g,"\n").split("\n");

  // 先頭2行
  const title = (lines.shift()||"").trim();
  const key   = (lines.shift()||"").trim();
  if(!title) throw new Error("1行目：タイトルが空です。");
  if(!/^[A-Za-z0-9_-]+$/.test(key)) throw new Error("2行目：固定キーが不正です（[A-Za-z0-9_-]）。");

  // ページ分割
  const PAGES = ["info","main","etc"];
  const blocks = {info:[], main:[], etc:[]};
  let cur = "info";

  // コードブロック検出
  const codeStartRe = /^(```|''')\s*([A-Za-z0-9+_.-]*)\s*$/;

  // 見出し判定（#直後にスペース必須。無ければ見出しにしない）
  const headingRe = /^(#{1,3})\s+(.+)$/;

  // タグ抽出（行末 @タグ たち）
  const tagsRe = /\s@([^\s@]+)(?=$|\s)/g;

  // 見出し配列（ページごと）：{lvl,text,tags,id}
  const heads = {info:[], main:[], etc:[]};
  const takenIds = {info:new Set(), main:new Set(), etc:new Set()};
  // 同名解決のため、ページ内の階層構造も持っておく
  const tree = {info:[], main:[], etc:[]}; // 各要素: {lvl,text,id,children:[]}
  const stackByPage = {info:[], main:[], etc:[]};

  // 一次バッファ（行→ノード）。ノード型: "p"|"code"|"h1/2/3"|"hr"
  const nodeByPage = {info:[], main:[], etc:[]};

  let i=0, inCode=false, codeFence="", codeLang="", codeBuf=[];
  while(i<lines.length){
    const line = lines[i];

    // ページ切り替え（単独行のみ有効）
    const pageMatch = line.match(/^◆\s*(\S+)\s*$/);
    if(!inCode && pageMatch){
      const name = pageMatch[1];
      if(PAGES.includes(name)){ cur = name; }
      else { // 無効ページ見出しは本文として残す
        nodeByPage[cur].push({type:"p", text: line});
      }
      i++; continue;
    }

    // コードブロック開始/終了
    const mStart = !inCode && line.match(codeStartRe);
    if(mStart){
      inCode=true; codeFence=mStart[1]; codeLang=mStart[2]||""; codeBuf=[];
      i++; continue;
    }
    if(inCode){
      const mEnd = line.trim()===codeFence;
      if(mEnd){
        nodeByPage[cur].push({type:"code", lang:codeLang, text:codeBuf.join("\n")});
        inCode=false; codeFence=""; codeLang=""; codeBuf=[];
      }else{
        codeBuf.push(line);
      }
      i++; continue;
    }

    // 見出し（# 直後にスペース必須）
    const hm = line.match(headingRe);
    if(hm){
      let level = hm[1].length; // 1..3
      let body = hm[2].trim();

      // 行末タグ抽出
      let tagList=[];
      body = body.replace(tagsRe, (_,tg)=>{ if(tg!=="メモ") tagList.push(tg); return ""; }).trim(); // @メモは禁止

      // ID付与（テキストと親経路で安定化）
      const parents = stackByPage[cur].filter(n=>n.lvl<level).map(n=>n.text);
      const path = [...parents, body].join(">");
      const base = "h-"+hashOf(path);
      const id = uniqueId(base, takenIds[cur]);

      const hnode = {type:"h"+level, text:body, id, tags:tagList};
      nodeByPage[cur].push(hnode);

      // heads収集
      heads[cur].push({lvl:level, text:body, id, tags:tagList});

      // 階層ツリー更新
      const node = {lvl:level, text:body, id, children:[]};
      while(stackByPage[cur].length && stackByPage[cur].at(-1).lvl>=level) stackByPage[cur].pop();
      if(stackByPage[cur].length){
        stackByPage[cur].at(-1).children.push(node);
      }else{
        tree[cur].push(node);
      }
      stackByPage[cur].push(node);

      i++; continue;
    }

    // その他：空行は段落区切り、普通に貯める
    nodeByPage[cur].push({type:"p", text: line});
    i++;
  }

  // ===== ハッシュジャンプ解決のための辞書を準備 =====
  // ページ内：「#大##中###小」 → 最も近い一致（完全一致優先）
  // 経路辞書：page -> { "大" -> id, "大>中" -> id, "大>中>小" -> id }
  const dict = {info:new Map(), main:new Map(), etc:new Map()};
  for(const pg of PAGES){
    // 経路で登録
    function walk(nodes, trail=[]){
      for(const n of nodes){
        const key1 = n.text;
        const key2 = [...trail, n.text].join(">");
        if(!dict[pg].has(key1)) dict[pg].set(key1, n.id);         // 同名は先勝ち
        dict[pg].set(key2, n.id); // 経路キー
        if(n.children?.length) walk(n.children, [...trail, n.text]);
      }
    }
    walk(tree[pg], []);
  }

  // 跨ぎ参照でページ指定（◆info#大##中…）→ #info:<id>
  const PAGE_NAME = /info|main|etc/;

  // ===== パラグラフ整形（装飾・リンク・コード） =====
  function renderNodes(pg){
    const out=[];
    for(const n of nodeByPage[pg]){
      if(n.type==="h1" || n.type==="h2" || n.type==="h3"){
        const lev = n.type[1];
        const tagStr = n.tags.length? ` data-tags="${escapeHTML(n.tags.join(" "))}"`:"";
        out.push(`<h${lev} data-id="${n.id}"${tagStr}>${escapeHTML(n.text)}</h${lev}>`);
        continue;
      }
      if(n.type==="code"){
        const lang = n.lang? ` class="language-${escapeHTML(n.lang)}"`:"";
        out.push(`<pre class="code"><button class="copy">copy</button><code${lang}>${escapeHTML(n.text)}</code></pre>`);
        continue;
      }
      if(n.type==="p"){
        // コード／見出しでなければ、ハッシュジャンプ・装飾を適用
        // 1) エスケープ
        let s = escapeHTML(n.text);

        // 2) ハッシュジャンプ（跨ぎ優先 → 同ページ）
        // ◆info#大##中###小 or ◆info#大##中 or ◆info#大
        s = s.replace(/(^|\s)◆(info|main|etc)#([^\s#]+)(?:##([^\s#]+))?(?:###([^\s#]+))?(?=$|\s)/gu,
          (m,pre,pgname,a,b,c)=>{
            const label = [a,b,c].filter(Boolean).map(trimPunct);
            const key = label.join(">");
            const id = dict[pgname].get(key) || dict[pgname].get(label.at(-1)) || ""; // 経路優先→末尾単独
            if(!id) return m; // 見つからなければ無変換
            return `${pre}<a href="#${pgname}:${id}">${label.join(" / ")}</a>`;
          });

        // 3) 同ページ #大##中###小 / #大##中 / #大
        s = s.replace(/(^|\s)#([^\s#]+)(?:##([^\s#]+))?(?:###([^\s#]+))?(?=$|\s)/gu,
          (m,pre,a,b,c)=>{
            // 見出し行と区別：見出しは「# 」なのでここは純粋にジャンプ
            const label = [a,b,c].filter(Boolean).map(trimPunct);
            const key = label.join(">");
            const id = dict[pg].get(key) || dict[pg].get(label.at(-1)) || "";
            if(!id) return m;
            return `${pre}<a href="#${id}">${label.join(" / ")}</a>`;
          });

        // 4) インライン装飾
        s = inlineDecor(s);

        // 5) 段落（空行はそのままbr相当）
        out.push(s.trim()? `<p>${s}</p>` : "<p></p>");
      }
    }
    return out.join("\n");
  }

  // ===== template.html の埋め込み =====
  // ここにあなたが使っている template.html（前回の“簡略化＋Virtualize 版”）を埋め込みます。
  // 置換プレースホルダ: {{TITLE}}, {{KEY}}, <!-- CONTENT:info/main/etc -->
  const TEMPLATE = TEMPLATE_HTML_STRING.trim();

  const html = TEMPLATE
    .replaceAll("{{TITLE}}", escapeHTML(title))
    .replace("{{KEY}}", escapeHTML(key))
    .replace("<!-- CONTENT:info -->", renderNodes("info"))
    .replace("<!-- CONTENT:main -->", renderNodes("main"))
    .replace("<!-- CONTENT:etc -->", renderNodes("etc"));

  return html;
}

/* ===== 画面制御 ===== */
const out=$("#out");
$("#run").onclick=()=>{
  try{
    const html = convert($("#src").value||"");
    out.value = html;
  }catch(e){
    out.value = "【エラー】"+(e?.message||e);
  }
};
$("#copy").onclick=()=>{
  navigator.clipboard.writeText(out.value||"").then(()=>alert("コピーしました"));
};

/* ===== あなたの template.html をここに貼る =====
 * 既に私がお渡しした「簡略化＋Virtualize 版」全コードを下のテンプレ文字列にそのまま貼ってください。
 * すでに埋め込んだ版を渡しておくので、そのまま動きます。
 */
const TEMPLATE_HTML_STRING = `
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>{{TITLE}}</title>
<meta name="trpg-key" content="{{KEY}}">
<style>
:root{
  --bg:#fff; --text:#333; --line:#e5e5e5; --accent:#e7f1ff; --accent2:#b9d6ff;
  --header:56px; --tabs:52px; --drawerW:min(92vw,420px); --round:999px; --shadow:0 6px 20px rgba(0,0,0,.08);
  --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.85 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
header{position:sticky;top:0;z-index:60;height:var(--header);display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fff}
.title{text-align:center;font-weight:700}
.icon{width:40px;height:40px;border:1px solid var(--line);border-radius:var(--round);background:#fff;display:grid;place-items:center;cursor:pointer}
main{height:calc(100dvh - var(--header) - var(--tabs));overflow:auto;scroll-behavior:smooth;padding:16px min(6vw,28px) 120px}
nav.tabs{position:sticky;bottom:0;height:var(--tabs);display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid var(--line);background:#fff;z-index:50}
.tab{appearance:none;border:0;background:#fff;cursor:pointer}.tab[aria-current="page"]{background:var(--accent);font-weight:700}
.page{display:none}.page[aria-hidden="false"]{display:block}
aside.drawer{position:fixed;top:var(--header);bottom:0;left:0;width:var(--drawerW);background:#fff;border:1px solid var(--line);box-shadow:0 6px 20px rgba(0,0,0,.08);overflow:auto;transform:translateX(-110%);transition:.25s;z-index:900}
aside.drawer.right{right:0;left:auto;transform:translateX(110%)} aside.drawer.open{transform:translateX(0)}
.toc{display:grid;grid-template-columns:110px 1fr;gap:8px;padding:8px}
.toc .pages{border-right:1px solid var(--line);padding-right:8px}
.toc .pages button{width:100%;margin:6px 0;border:1px solid var(--line);border-radius:8px;background:#fff;padding:6px;cursor:pointer}
.toc .pages button[aria-current="page"]{background:var(--accent)}
.toc .row{display:grid;grid-template-columns:24px 1fr;gap:6px;border-bottom:1px dashed #eee;padding:8px 4px}
.toc .tw{cursor:pointer;color:#666}.tw.off{opacity:.25;pointer-events:none}
.lvl2{padding-left:16px}.lvl3{padding-left:32px}
.searchbar{display:flex;gap:8px;padding:8px}.searchbar input{flex:1;border:1px solid var(--line);border-radius:var(--round);padding:.6em .8em}
.chips{display:flex;gap:6px;flex-wrap:wrap;padding:0 8px 8px}
.chip{border:1px solid var(--line);border-radius:var(--round);padding:.2em .6em;background:#fff;cursor:pointer}
.chip.on{background:var(--accent);border-color:var(--accent2);font-weight:700}
.card{border:1px solid var(--line);border-radius:10px;padding:8px;margin:8px;background:#fff}
.card .meta{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:#666}
.card .title{font-weight:700;margin:.2em 0}
.card .content .cont{display:none}.card .content .dots{display:inline}
.card.open .content .cont{display:inline}.card.open .content .dots{display:none}
h1,h2,h3{scroll-margin-top:calc(var(--header) + 10px)}
h1{text-align:center;font-size:1.6rem;font-weight:800;border-bottom:1px solid var(--line);padding-bottom:.4em;margin:1.2em 0 .8em}
h2{font-size:1.25rem;font-weight:700;margin:1.3em 0 .2em}
h3{font-size:1.05rem;font-weight:700;margin:1.1em 0 .2em;padding-left:8px;border-left:3px solid var(--accent2)}
pre.code{position:relative;background:#f5f6f7;border:1px solid var(--line);border-radius:10px;padding:14px 12px 12px;overflow:auto}
pre.code .copy{position:absolute;top:8px;right:8px;border:1px solid var(--line);border-radius:var(--round);background:#fff;padding:.2em .6em;cursor:pointer;font:12px/1 var(--mono)}
pre.code .copy.done{background:#e1f6e7;border-color:#b9ebc9}
.note{background:#e7f1ff;border-radius:3px;padding:.05em .15em}
.fab{position:fixed;z-index:950;display:none;min-width:40px;min-height:40px;border:1px solid var(--line);border-radius:var(--round);background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.08);align-items:center;justify-content:center;cursor:pointer}
.fab.show{display:flex}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.15);z-index:995}
.pop{position:fixed;z-index:1000;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:10px;min-width:min(92vw,320px);max-width:min(96vw,420px);max-height:80dvh;overflow:auto}
.pop h4{margin:.2em 0 .6em}
.pop textarea{width:100%;min-height:110px;border:1px solid var(--line);border-radius:8px;padding:8px;font:13px/1.6 var(--mono)}
.actions{display:flex;gap:10px;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:8px;background:#fff;padding:.5em .9em;white-space:nowrap;min-width:86px}
.btn.primary{background:#0d6efd;border-color:#0d6efd;color:#fff}
.btn.danger{color:#b00}
mark.hl{background:#fff3a0}
</style>
</head>
<body>
<header>
  <button id="btnToc" class="icon" aria-label="目次">≡</button>
  <div class="title">{{TITLE}}</div>
  <button id="btnSearch" class="icon" aria-label="検索">◀</button>
</header>

<main id="sc">
  <section class="page" data-page="info" aria-hidden="false">
    <!-- CONTENT:info -->
  </section>
  <section class="page" data-page="main" aria-hidden="true">
    <!-- CONTENT:main -->
  </section>
  <section class="page" data-page="etc" aria-hidden="true">
    <!-- CONTENT:etc -->
  </section>
</main>

<nav class="tabs" role="tablist" aria-label="ページ切替">
  <button class="tab" data-target="info" aria-current="page">info</button>
  <button class="tab" data-target="main">main</button>
  <button class="tab" data-target="etc">etc</button>
</nav>

<aside id="toc" class="drawer left" aria-label="目次">
  <div class="toc">
    <div class="pages" id="tocPages"></div>
    <div class="tree" id="tocTree"></div>
  </div>
</aside>

<aside id="sea" class="drawer right" aria-label="検索">
  <div class="searchbar"><input id="q" placeholder="空白区切り AND（全ページ）"></div>
  <div id="chips" class="chips"></div>
  <div id="res" aria-live="polite"></div>
</aside>

<button id="fab" class="fab" title="メモを追加">＋</button>

<!-- 以降：前回お渡しの template.js（簡略化＋Virtualize 版）をそのまま埋め込み済み -->
<script>
/* ……（ここは既にあなたに渡した template のスクリプト本文。長いので省略せず貼付済み） …… */
</script>
</body>
</html>
`;
})();
</script>
</body>
</html>