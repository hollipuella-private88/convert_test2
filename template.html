<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>{{TITLE}}</title>
<meta name="trpg-key" content="{{KEY}}">
<style>
:root{
  --bg:#fff; --text:#333; --line:#e5e5e5; --accent:#e7f1ff; --accent2:#b9d6ff;
  --header:56px; --tabs:52px; --drawerW:min(92vw,420px); --r:12px; --sh:0 6px 20px rgba(0,0,0,.08);
  --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.85 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}

/* header */
header{position:sticky;inset-block-start:0;z-index:60;height:var(--header);display:grid;grid-template-columns:auto 1fr auto;place-items:center;padding:8px;border-block-end:1px solid var(--line);background:#fff}
.title{text-align:center;font-weight:700}
.icon{min-inline-size:44px;min-block-size:40px;border:1px solid var(--line);border-radius:10px;background:#fff;display:inline-grid;place-items:center;cursor:pointer;padding:0 .9em}
.icon:focus-visible{outline:2px solid #2563eb;outline-offset:2px}

/* main and tabs */
main{block-size:calc(100dvh - var(--header) - var(--tabs));overflow:auto;scroll-behavior:smooth;padding:16px min(6vw,28px) 120px}
nav.tabs{position:sticky;inset-block-end:0;block-size:var(--tabs);display:grid;grid-template-columns:repeat(3,1fr);border-block-start:1px solid var(--line);background:#fff;z-index:50}
.tab{appearance:none;border:0;background:#fff;cursor:pointer;padding:.6em 0}
.tab[aria-current="page"]{background:var(--accent);font-weight:700}
.page{display:none}
.page[aria-hidden="false"]{display:block}

/* drawers */
.drawer{position:fixed;inset-block-start:var(--header);inset-block-end:0;inline-size:var(--drawerW);background:#fff;border:1px solid var(--line);box-shadow:var(--sh);overflow:auto;transition:.25s;z-index:900}
.drawer.left{inset-inline-start:0;transform:translateX(-110%)}
.drawer.right{inset-inline-end:0;transform:translateX(110%)}
.drawer.open{transform:translateX(0)}

/* TOC/Tool drawer content */
.toc{display:grid;grid-template-columns:120px 1fr;gap:8px;padding:8px}
.toc .pages{border-inline-end:1px solid var(--line);padding-inline-end:8px;display:flex;flex-direction:column;gap:6px}
.toc .pages button{inline-size:100%;margin:0;border:1px solid var(--line);border-radius:8px;background:#fff;padding:6px;cursor:pointer;text-align:center}
.toc .pages button[aria-current="page"]{background:var(--accent);border-color:var(--accent2);font-weight:700}
.toc .area{padding-inline:4px}

/* TOC-like rows (used for both TOC and Tool) */
.toc .row{display:grid;grid-template-columns:24px 1fr;gap:6px;border-block-end:1px dashed #eee;padding:8px 4px}
.toc .tw{cursor:pointer;color:#666}.toc .tw.off{opacity:.25;pointer-events:none}
.lvl2{padding-inline-start:16px}.lvl3{padding-inline-start:32px}

/* search */
.searchbar{display:flex;gap:8px;padding:8px}
.searchbar input{flex:1;border:1px solid var(--line);border-radius:999px;padding:.6em .9em}
.chips{display:flex;gap:6px;flex-wrap:wrap;padding:0 8px 8px}
.chip{border:1px solid var(--line);border-radius:999px;padding:.2em .6em;background:#fff;cursor:pointer}
.chip.on{background:var(--accent);border-color:var(--accent2);font-weight:700}

/* card */
.card{border:1px solid var(--line);border-radius:10px;padding:8px;margin:8px;background:#fff}
.card .meta{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:#666}
.card .title{font-weight:700;margin:.2em 0}
.card .fulltext{
  display:-webkit-box;
  -webkit-line-clamp:1;
  -webkit-box-orient:vertical;
  overflow:hidden;
  text-overflow:ellipsis;
}
.card.open .fulltext{
  display:block;
  -webkit-line-clamp:unset;
  overflow:visible;
}
.card .fulltext .note{background:#e7f1ff;border-radius:3px;padding:.05em .15em}

/* headings & code */
h1,h2,h3{scroll-margin-top:calc(var(--header) + 10px)}
h1{text-align:center;font-size:1.6rem;font-weight:800;border-block-end:1px solid var(--line);padding-block-end:.4em;margin:1.2em 0 .8em}
h2{font-size:1.25rem;font-weight:700;margin:1.3em 0 .2em}
h3{font-size:1.05rem;font-weight:700;margin:1.1em 0 .2em;padding-inline-start:8px;border-inline-start:3px solid var(--accent2)}

/* code wrap */
pre.code{position:relative;background:#f5f6f7;border:1px solid var(--line);border-radius:10px;padding:14px 12px 12px;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word}
pre.code code{white-space:inherit}
pre.code .copy{position:absolute;inset:8px 8px auto auto;border:1px solid var(--line);border-radius:999px;background:#fff;padding:.2em .6em;cursor:pointer;font:12px/1 var(--mono)}
pre.code .copy.done{background:#e1f6e7;border-color:#b9ebc9}

/* memo */
.note{background:#e7f1ff;border-radius:3px;padding:.05em .15em}
.fab{position:fixed;z-index:950;display:none;min-inline-size:40px;min-block-size:40px;border:1px solid var(--line);border-radius:999px;background:#fff;box-shadow:var(--sh);place-items:center;cursor:pointer}
.fab.show{display:grid}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.15);z-index:995}
.pop{position:fixed;z-index:1000;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--sh);padding:10px;min-inline-size:min(92vw,320px);max-inline-size:min(96vw,420px);max-block-size:80dvh;overflow:auto}
.pop h4{margin:.2em 0 .6em}
.pop textarea{inline-size:100%;min-block-size:110px;border:1px solid var(--line);border-radius:8px;padding:8px;font:13px/1.6 var(--mono)}
.actions{display:flex;gap:10px;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:8px;background:#fff;padding:.5em .9em;white-space:nowrap;min-inline-size:86px}
.btn.primary{background:#0d6efd;border-color:#0d6efd;color:#fff}
.btn.danger{color:#b00}
mark.hl{background:#fff3a0}

/* tool */
.tool-word{border-bottom:1px solid var(--line);padding-bottom:4px}
.input-box{width:100%;border:1px solid var(--line);border-radius:8px;padding:.5em .7em;margin:6px 0 12px;background:#fff}

/* spacing fix */
.card .fulltext > :first-child{ margin-block-start:0 !important; }
.card .fulltext > :last-child { margin-block-end:0 !important; }
.card .fulltext > p,
.card .fulltext > ul,
.card .fulltext > ol,
.card .fulltext > pre,
.card .fulltext > blockquote { margin-block:.35em .4em; }
</style>
</head>
<body>
<header>
  <button id="btnToc" class="icon" aria-label="目次">≡</button>
  <div class="title">{{TITLE}}</div>
  <button id="btnSearch" class="icon" aria-label="検索">◀</button>
</header>

<main id="sc">
  <section class="page" data-page="info" aria-hidden="false"><!-- CONTENT:info --></section>
  <section class="page" data-page="main" aria-hidden="true"><!-- CONTENT:main --></section>
  <section class="page" data-page="etc"  aria-hidden="true"><!-- CONTENT:etc --></section>
</main>

<nav class="tabs" role="tablist" aria-label="ページ切替">
  <button class="tab" data-target="info" aria-current="page">info</button>
  <button class="tab" data-target="main">main</button>
  <button class="tab" data-target="etc">etc</button>
</nav>

<aside id="toc" class="drawer left" aria-label="目次/ツール">
  <div class="toc">
    <div class="pages" id="tocPages"></div>
    <div class="area" id="tocArea"></div>
  </div>
</aside>

<aside id="sea" class="drawer right" aria-label="検索">
  <div class="searchbar"><input id="q" placeholder="空白区切り AND（全ページ）"></div>
  <div id="chips" class="chips"></div>
  <div id="res" aria-live="polite"></div>
</aside>

<button id="fab" class="fab" title="メモを追加">＋</button>

<script id="convert-words" type="application/json">{"words":[]}</script>

<script>
(()=>{"use strict";
// ～～～ 中略（前回お渡しした全文と同じ）～～～
// renderTool 内の該当部分だけ修正 ↓↓↓

function renderTool(area){
  stateTool.words = readConvertWords();
  if(!stateTool.valuesInit){ stateTool.values = loadReplacerValues(); stateTool.valuesInit=true; }

  const addRow=(label, onToggle)=>{
    const d=document.createElement("div"); d.className="row";
    const tw=document.createElement("div"); tw.className="tw"; tw.textContent=stateTool.secOpen[label]?"▼":"▶";
    const j=document.createElement("div"); j.textContent=label;
    tw.onclick=()=>{ stateTool.secOpen[label]=!stateTool.secOpen[label]; onToggle(); };
    j.onclick=()=>{ stateTool.secOpen[label]=!stateTool.secOpen[label]; onToggle(); };
    d.append(tw,j); area.appendChild(d);
  };

  addRow("メモ管理", ()=>renderTOC_orToolArea());
  if(stateTool.secOpen["メモ管理"]){
    const btn=document.createElement("button"); btn.className="btn danger"; btn.textContent="全メモ削除";
    btn.style.margin="6px 8px 12px";
    btn.onclick=()=>{ if(!confirm("全メモを削除します。よろしいですか？")) return; clearAllNotes(); buildIndex(); buildChips(); search(); alert("削除しました"); };
    area.appendChild(btn);
  }

  addRow("文字変換", ()=>renderTOC_orToolArea());
  if(stateTool.secOpen["文字変換"]){
    if(!stateTool.words.length){
      const p=document.createElement("p"); p.style.margin="6px 8px 0"; p.textContent="◆ convert に語を 1行1語で列挙すると、ここに表示されます。";
      area.appendChild(p);
    }else{
      stateTool.words.forEach(word=>{
        const row=document.createElement("div"); row.className="row";
        const tw=document.createElement("div"); tw.className="tw"; tw.textContent=stateTool.secOpen[word]?"▼":"▶";
        const j=document.createElement("div"); j.textContent=word; j.classList.add("lvl2","tool-word");
        tw.onclick=()=>{ stateTool.secOpen[word]=!stateTool.secOpen[word]; renderTOC_orToolArea(); };
        j.onclick=()=>{ stateTool.secOpen[word]=!stateTool.secOpen[word]; renderTOC_orToolArea(); };
        row.append(tw,j); area.appendChild(row);

        if(stateTool.secOpen[word]){
          const wrap=document.createElement("div"); wrap.style.margin="0 8px 0 48px";
          const input=document.createElement("input"); input.type="text"; input.className="input-box"; 
          input.placeholder=word; // ★修正：短く（変換語だけ）
          input.value = stateTool.values[word] || "";

          input.addEventListener("compositionstart",()=>{stateTool.composing=true;});
          input.addEventListener("compositionend",()=>{stateTool.composing=false; stateTool.values[word]=input.value; stateTool.dirty=true;});
          input.addEventListener("input",()=>{ if(stateTool.composing) return; stateTool.values[word]=input.value; stateTool.dirty=true; });
          input.addEventListener("blur", ()=>{ stateTool.values[word]=input.value; stateTool.dirty=true; });
          input.addEventListener("change",()=>{ stateTool.values[word]=input.value; stateTool.dirty=true; });

          wrap.appendChild(input); area.appendChild(wrap);
        }
      });
    }
  }
}

// ～～～ 以下のコードは前回の全文と同じ（検索・ジャンプ・置換など）～～～
})();
</script>
</body>
</html>