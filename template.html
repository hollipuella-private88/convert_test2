/* ===== highlight & links ===== */
function clearHL(){ $$(".hl-tmp",sc).forEach(m=>m.replaceWith(document.createTextNode(m.textContent))); }
function highlight(el,ws,includeCode=false){
  const root=(el.closest("section")||sc);
  const tw=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,{acceptNode(n){
    if(!n.nodeValue.trim())return NodeFilter.FILTER_REJECT;
    const p=n.parentElement;
    if(!includeCode && p && p.closest("pre,code,.code")) return NodeFilter.FILTER_REJECT;
    if(p && p.classList.contains("note")) return NodeFilter.FILTER_REJECT;
    return NodeFilter.FILTER_ACCEPT;
  }});
  const re=new RegExp("("+ws.map(w=>w.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&")).join("|")+")","ig"), targets=[];
  while(tw.nextNode()){const n=tw.currentNode; if(re.test(n.nodeValue)) targets.push(n);}
  targets.forEach(n=>{
    const parts=n.nodeValue.split(re), f=document.createDocumentFragment();
    parts.forEach(t=>{ if(!t) return; if(ws.some(w=>t.toLowerCase()===w.toLowerCase())){ const m=document.createElement("mark"); m.className="hl-tmp"; m.textContent=t; f.appendChild(m);} else f.appendChild(document.createTextNode(t));});
    n.parentNode.replaceChild(f,n);
  });
}
addEventListener("hashchange",()=>{
  const {id,page}=parseHash(location.hash); if(!id) return; const ent=ID.get(id); if(!ent) return;
  const targetPage=page||ent.page, act=()=>{ const sec=pages.find(p=>p.dataset.page===targetPage);
    (sec.querySelector('[data-id="'+CSS.escape(id)+'"],#'+CSS.escape(id))||ent.el).scrollIntoView({block:"start",behavior:"smooth"}); };
  if(targetPage!==S.page){ switchPage(targetPage); requestAnimationFrame(act);} else act();
});
function linkNames(){
  $$('a[href^="#"]',sc).forEach(a=>{
    if(a.textContent.trim()) return; const {id,page}=parseHash(a.getAttribute("href")); const ent=ID.get(id); if(!ent) return;
    a.textContent=ent.text; a.title=ent.text;
    a.addEventListener("click",ev=>{ev.preventDefault(); location.hash="#"+((page||ent.page)+":"+id);},{once:true});
  });
}
function jump(e,ws){
  const go=()=>{
    e.el.scrollIntoView({block:"start",behavior:"smooth"});
    applyReplacements_ifNeeded();
    clearHL();
    if(ws.length && e.kind!=="memo"){
      highlight(e.el, ws, true);
      const target = firstMarkUnderHeading(e.el) || $(".hl-tmp");
      (target || e.el).scrollIntoView({block:"center",behavior:"smooth"});
    }
    if(MOBILE()) sea.classList.remove("open");
  };
  if(e.page!==S.page){
    switchPage(e.page);
    requestAnimationFrame(()=>{ const sec=pages.find(p=>p.dataset.page===e.page);
      if(e.kind!=="memo"){ e.el=sec.querySelector('[data-id="'+CSS.escape(e.id)+'"],#'+CSS.escape(e.id))||e.el; }
      go();
    });
  } else go();
}

/* ===== code copy ===== */
document.addEventListener("click",async e=>{
  const b=e.target.closest(".code .copy"); if(!b) return;
  const code=b.parentElement.querySelector("code").innerText;
  try{ await navigator.clipboard.writeText(code); b.classList.add("done"); b.textContent="copied ✓";
       setTimeout(()=>{b.classList.remove("done"); b.textContent="copy";},900); }catch{ alert("copy failed"); }
});

/* ===== memo (追加/編集/削除) ===== */
const fab=$("#fab"); let sel=null, pop=null, bd=null;
const blockOf=n=>(n.nodeType===1?n:n.parentElement)?.closest("h1,h2,h3,p,li,blockquote,pre,dd,td,div");
function getRange(){
  const s=getSelection(); if(!s||s.isCollapsed) return null;
  const r=s.getRangeAt(0).cloneRange(); const b=blockOf(r.startContainer), c=blockOf(r.endContainer);
  if(!b||!c||b!==c) return null; if(b.closest(".note")||c.closest(".note")) return null;
  if(!sc.contains(b)||r.toString().trim().length>300) return null; return r;
}
function place(el,rect){ const v=vp(),pad=8,ew=el.offsetWidth||40,eh=el.offsetHeight||40;
  let x=rect.left+rect.width/2+(scrollX||0)-ew/2, y=rect.top+(scrollY||0)-48;
  el.style.left=Math.min(Math.max(x,v.x+pad),v.x+v.w-ew-pad)+"px";
  el.style.top=Math.min(Math.max(y,v.y+pad),v.y+v.h-eh-pad)+"px";
}
function showFab(){ sel=getRange(); if(!sel){ fab.classList.remove("show"); return; } const r=sel.getBoundingClientRect(); fab.classList.add("show"); place(fab,r); }
sc.addEventListener("pointerup",()=>setTimeout(showFab,0),{passive:true});
addEventListener("scroll",()=>fab.classList.remove("show"),{passive:true});
fab.onclick=()=>{ if(!sel) return; openNote({range:sel}); fab.classList.remove("show"); getSelection().removeAllRanges(); };

function placePop(el,anchorRect,prefer="below"){
  const pad=8, v=vp(); const ew=el.offsetWidth||320, eh=el.offsetHeight||200;
  const ax=anchorRect.left+anchorRect.width/2+(scrollX||0), ay=anchorRect.top+(scrollY||0);
  let x=ax-ew/2, y=(prefer==="below"? ay+anchorRect.height+10 : ay-eh-10);
  if(prefer==="below" && y+eh>v.y+v.h-pad) y=ay-eh-10; if(prefer==="above" && y<v.y+pad) y=ay+anchorRect.height+10;
  if(y+eh>v.y+v.h-pad||y<v.y+pad) y=v.y+(v.h-eh)/2; x=Math.min(Math.max(x,v.x+pad),v.x+v.w-ew-pad);
  el.style.left=x+"px"; el.style.top=y+"px";
}
function openNote({range,node}){
  closePop();
  bd=document.createElement("div"); bd.className="backdrop"; bd.addEventListener("pointerdown",(ev)=>{ if(ev.target===bd) closePop(); }); document.body.appendChild(bd);
  pop=document.createElement("div"); pop.className="pop"; pop.setAttribute("role","dialog"); pop.setAttribute("aria-modal","true"); pop.tabIndex=-1;
  ["pointerdown","pointerup","click"].forEach(ev=>pop.addEventListener(ev,e=>e.stopPropagation()));
  const head=document.createElement("h4"); head.textContent=node?"メモを編集":"メモを追加";
  const prev=document.createElement("div"); prev.style.cssText="font-size:12px;color:#666"; prev.textContent="選択："+(node?node.textContent.slice(0,30):range.toString().slice(0,30));
  const ta=document.createElement("textarea"); if(node) ta.value=node.dataset.note||"";
  const act=document.createElement("div"); act.className="actions";
  const sv=document.createElement("button"); sv.type="button"; sv.className="btn primary"; sv.textContent="保存";
  const cn=document.createElement("button"); cn.type="button"; cn.className="btn"; cn.textContent="やめる";
  act.append(sv,cn);
  if(node){ const del=document.createElement("button"); del.type="button"; del.className="btn danger"; del.textContent="削除"; del.style.cssText="position:absolute;inset:10px 10px auto auto";
    del.addEventListener("click",(ev)=>{ev.stopPropagation(); if(!confirm("このメモを削除しますか？")) return; unwrap(node); closePop(); persistNotes(); buildIndex(); buildChips(); search();});
    pop.append(del);
  }
  pop.append(head,prev,ta,act); document.body.appendChild(pop);
  const rect=(range?range.getBoundingClientRect():node.getBoundingClientRect());
  requestAnimationFrame(()=>{ placePop(pop,rect,"below"); pop.focus(); });
  cn.onclick=()=>closePop();
  sv.onclick=()=>{
    if(node){ node.dataset.note=ta.value.trim(); closePop(); persistNotes(); buildIndex(); buildChips(); search(); }
    else{
      const span=document.createElement("span"); span.className="note"; span.dataset.note=ta.value.trim();
      try{ range.surroundContents(span);}catch{ const frag=range.extractContents(); span.appendChild(frag); range.insertNode(span); }
      span.addEventListener("click",(e)=>{e.stopPropagation(); openNote({node:span});});
      closePop(); persistNotes(); buildIndex(); buildChips(); search();
    }
  };
}
function closePop(){ pop?.remove(); pop=null; bd?.remove(); bd=null; }
function unwrap(span){ const p=span.parentNode; while(span.firstChild) p.insertBefore(span.firstChild,span); p.removeChild(span); }
function hookNotes(){ $$(".note",sc).forEach(n=>{ if(n._hooked) return; n.addEventListener("click",(e)=>{e.stopPropagation(); openNote({node:n});}); n._hooked=true; }); }

/* ===== memo persist ===== */
// ... persistNotes, restoreNotes, clearAllNotes は前回と同じ（省略） ...

/* ===== Text Replacement (表示のみ) ===== */
// ... buildSnapshot, replaceInString, replaceInNodeTree, applyReplacements 等は前回と同じ ...

/* ===== カード作成 ===== */
function makeCard(e, ws){
  const card=document.createElement("div"); card.className="card";

  const meta=document.createElement("div"); meta.className="meta";
  const jb=document.createElement("button"); jb.type="button"; jb.textContent="ジャンプ"; jb.className="btn";
  jb.onclick=(ev)=>{ev.stopPropagation(); jump(e,ws);};
  const bc=document.createElement("div"); bc.textContent=crumb(e);
  meta.append(bc,jb);

  const ttl=document.createElement("div"); ttl.className="title";
  ttl.textContent = (e.kind==="memo" ? "［メモ］"+(e.sel?e.sel.slice(0,30):"") : e.text);

  const content=document.createElement("div"); content.className="content";
  const full=document.createElement("div"); full.className="fulltext";

  if(e.kind==="memo"){
    const safe = (e.body||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/\n/g,"<br>");
    full.innerHTML = safe || "（メモなし）";
  }else{
    const frag=getHeadingRangeFragment(e);
    replaceInNodeTree(frag);
    full.appendChild(frag);
  }

  content.appendChild(full);
  card.append(meta,ttl,content);
  card.onclick=()=>{ card.classList.toggle("open"); };
  return card;
}

/* ===== init ===== */
autoBoxCodes();
restoreNotes();
hookNotes();
buildIndex(); buildChips(); buildTOC_orTool(); search(); linkNames();
buildSnapshot();
})();
</script>
</body>
</html>