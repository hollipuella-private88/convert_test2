<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>{{TITLE}}</title>
<meta name="trpg-key" content="{{KEY}}">
<style>
:root{
  --bg:#fff; --text:#333; --line:#e5e5e5; --accent:#e7f1ff; --accent2:#b9d6ff;
  --header:56px; --tabs:52px; --drawerW:min(92vw,420px); --round:999px; --shadow:0 6px 20px rgba(0,0,0,.08);
  --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.85 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
header{position:sticky;top:0;z-index:50;height:var(--header);display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:#fff}
.title{text-align:center;font-weight:700}
.icon{width:40px;height:40px;border:1px solid var(--line);border-radius:var(--round);background:#fff;display:grid;place-items:center;cursor:pointer}
main{height:calc(100dvh - var(--header) - var(--tabs));overflow:auto;scroll-behavior:smooth;padding:16px min(6vw,28px) 120px}
nav.tabs{position:sticky;bottom:0;height:var(--tabs);display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid var(--line);background:#fff;z-index:40}
.tab{appearance:none;border:0;background:#fff;cursor:pointer}.tab[aria-current="page"]{background:var(--accent);font-weight:700}
.page{display:none}.page[aria-hidden="false"]{display:block}
/* ドロワー */
aside.drawer{position:fixed;top:var(--header);bottom:0;width:var(--drawerW);background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);overflow:auto;transform:translateX(-110%);transition:.25s}
aside.drawer.right{right:0;left:auto;transform:translateX(110%)} aside.drawer.open{transform:translateX(0)}
/* TOC */
.toc{display:grid;grid-template-columns:110px 1fr;gap:8px;padding:8px}
.toc .pages{border-right:1px solid var(--line);padding-right:8px}
.toc .pages button{width:100%;margin:6px 0;border:1px solid var(--line);border-radius:8px;background:#fff;padding:6px;cursor:pointer}
.toc .pages button[aria-current="page"]{background:var(--accent)}
.toc .row{display:grid;grid-template-columns:24px 1fr;gap:6px;border-bottom:1px dashed #eee;padding:8px 4px}
.toc .tw{cursor:pointer;color:#666}.tw.off{opacity:.25;pointer-events:none}
.lvl2{padding-left:16px}.lvl3{padding-left:32px}
/* 検索 */
.searchbar{display:flex;gap:8px;padding:8px}.searchbar input{flex:1;border:1px solid var(--line);border-radius:var(--round);padding:.6em .8em}
.chips{display:flex;gap:6px;flex-wrap:wrap;padding:0 8px 8px}
.chip{border:1px solid var(--line);border-radius:var(--round);padding:.2em .6em;background:#fff;cursor:pointer}
.chip.on{background:var(--accent);border-color:var(--accent2);font-weight:700}
.card{border:1px solid var(--line);border-radius:10px;padding:8px;margin:8px;background:#fff}
.card .meta{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:#666}
.card .title{font-weight:700;margin:.2em 0}
.card .content .cont{display:none}.card .content .dots{display:inline}
.card.open .content .cont{display:inline}.card.open .content .dots{display:none}
/* 見出し & コード */
h1,h2,h3{scroll-margin-top:calc(var(--header) + 10px)}
h1{text-align:center;font-size:1.6rem;font-weight:800;border-bottom:1px solid var(--line);padding-bottom:.4em;margin:1.2em 0 .8em}
h2{font-size:1.25rem;font-weight:700;margin:1.3em 0 .2em}
h3{font-size:1.05rem;font-weight:700;margin:1.1em 0 .2em;padding-left:8px;border-left:3px solid var(--accent2)}
pre.code{position:relative;background:#f5f6f7;border:1px solid var(--line);border-radius:10px;padding:14px 12px 12px;overflow:auto}
pre.code .copy{position:absolute;top:8px;right:8px;border:1px solid var(--line);border-radius:var(--round);background:#fff;padding:.2em .6em;cursor:pointer;font:12px/1 var(--mono)}
pre.code .copy.done{background:#e1f6e7;border-color:#b9ebc9}
/* メモ */
.note{background:#e7f1ff;border-radius:3px;padding:.05em .15em}
.fab{position:fixed;z-index:65;display:none;min-width:40px;min-height:40px;border:1px solid var(--line);border-radius:var(--round);background:#fff;box-shadow:var(--shadow);align-items:center;justify-content:center;cursor:pointer}
.fab.show{display:flex}
.pop{position:fixed;z-index:70;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:10px;min-width:min(92vw,320px);max-width:min(96vw,420px);max-height:80dvh;overflow:auto}
.pop h4{margin:.2em 0 .6em}
.pop textarea{width:100%;min-height:110px;border:1px solid var(--line);border-radius:8px;padding:8px;font:13px/1.6 var(--mono)}
.actions{display:flex;gap:10px;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:8px;background:#fff;padding:.5em .9em;white-space:nowrap;min-width:86px}
.btn.primary{background:#0d6efd;border-color:#0d6efd;color:#fff}
.btn.danger{color:#b00}
mark.hl{background:#fff3a0}
@media(max-width:768px){.toc{grid-template-columns:90px 1fr}}
</style>
</head>
<body>
<header>
  <button id="btnToc" class="icon" aria-label="目次">≡</button>
  <div class="title">{{TITLE}}</div>
  <button id="btnSearch" class="icon" aria-label="検索">◀</button>
</header>

<main id="sc">
  <section class="page" data-page="info" aria-hidden="false">
    <!-- CONTENT:info -->
  </section>
  <section class="page" data-page="main" aria-hidden="true">
    <!-- CONTENT:main -->
  </section>
  <section class="page" data-page="etc" aria-hidden="true">
    <!-- CONTENT:etc -->
  </section>
</main>

<nav class="tabs" role="tablist" aria-label="ページ切替">
  <button class="tab" data-target="info" aria-current="page">info</button>
  <button class="tab" data-target="main">main</button>
  <button class="tab" data-target="etc">etc</button>
</nav>

<aside id="toc" class="drawer left" aria-label="目次">
  <div class="toc">
    <div class="pages" id="tocPages"></div>
    <div class="tree" id="tocTree"></div>
  </div>
</aside>

<aside id="sea" class="drawer right" aria-label="検索">
  <div class="searchbar"><input id="q" placeholder="空白区切り AND（全ページ）"></div>
  <div id="chips" class="chips"></div>
  <div id="res"></div>
</aside>

<button id="fab" class="fab" title="メモを追加">＋</button>

<script>
(()=>{"use strict";
/* ==== 小道具 ==== */
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const sc=$("#sc"), pages=$$(".page"), tabs=$$(".tab"), toc=$("#toc"), sea=$("#sea"), btnT=$("#btnToc"), btnS=$("#btnSearch");
const MOBILE=()=>matchMedia("(max-width:768px)").matches;

/* ==== 固定キー（localStorage分離） ==== */
const FIXED_KEY = (document.querySelector('meta[name="trpg-key"]')?.content||"").trim();
if(!/^[A-Za-z0-9_-]+$/.test(FIXED_KEY)){ alert("テンプレートの固定キー(meta[name=trpg-key])が不正です。"); }
const MEMO_KEY = "trpg:"+FIXED_KEY+":memos";

/* ==== 状態 ==== */
const S={page:"info",index:new Map(),tags:new Set()};
let ALL=[], ID=new Map();

/* ==== ビューポート補助 ==== */
function vport(){const vv=window.visualViewport; return vv? {x:vv.offsetLeft,y:vv.offsetTop,w:vv.width,h:vv.height}: {x:0,y:0,w:innerWidth,h:innerHeight};}
const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);

/* ==== ヘッダーアイコン（閉:◀／開:▶） ==== */
const updIcon=()=>{ btnS.textContent=sea.classList.contains("open")?"▶":"◀"; };
const setOpen=(el,on)=>{ el.classList.toggle("open",!!on); if(el===sea)updIcon(); if(on&&el===toc) sea.classList.remove("open"); };
btnT.onclick=()=>setOpen(toc,!toc.classList.contains("open"));
btnS.onclick=()=>setOpen(sea,!sea.classList.contains("open"));
new MutationObserver(updIcon).observe(sea,{attributes:true,attributeFilter:["class"]}); updIcon();

/* ==== ページ切替 ==== */
tabs.forEach(b=>b.onclick=()=>switchPage(b.dataset.target));
function switchPage(p){
  if(S.page===p)return;
  pages.forEach(sec=>sec.setAttribute("aria-hidden",sec.dataset.page===p?"false":"true"));
  tabs.forEach(b=>b.setAttribute("aria-current",b.dataset.target===p?"page":"false"));
  S.page=p; buildTOC(); buildChips(); if(sea.classList.contains("open")) search();
}

/* ==== 見出し & 本文抽出（親本文のみ） ==== */
function heads(sec){
  const hs=$$("h1,h2,h3",sec).map(h=>{
    if(h.dataset.id&&!h.id)h.id=h.dataset.id;
    return {el:h,l:+h.tagName.slice(1),id:h.dataset.id||h.id,text:h.textContent.trim(),
            tags:(h.dataset.tags||"").split(/\s+/).filter(Boolean),children:[],parent:null,page:sec.dataset.page};
  });
  const st=[]; hs.forEach(x=>{while(st.length&&st.at(-1).l>=x.l)st.pop(); if(st.length){x.parent=st.at(-1); st.at(-1).children.push(x);} st.push(x);});
  return hs;
}
function bodyText(h){
  const L=h.tagName; let n=h.nextSibling, t="";
  while(n){
    if(n.nodeType===1){
      const tn=n.tagName;
      if((tn==="H1"&&(L==="H1"||L==="H2"||L==="H3"))||(tn==="H2"&&(L==="H2"||L==="H3"))||(tn==="H3"&&L==="H3")) break;
      if(n.matches("h1,h2,h3")) break;
      t+=" "+n.textContent.trim();
    }else if(n.nodeType===3){ t+=" "+n.textContent.trim(); }
    n=n.nextSibling; if(n&&n.nodeType===1&&n.matches("h1,h2,h3")) break;
  }
  return t.replace(/\s+/g," ").trim();
}

/* ==== 見出し検索 ==== */
function nearestHeading(el){
  let n=(el.nodeType===1?el:el.parentElement);
  while(n){ if(n.matches&&n.matches("h1,h2,h3")) return n; n=n.parentElement; }
  // 前方探索
  n=el; while(n){
    let p=n; while(p){
      if(p.previousElementSibling){ p=p.previousElementSibling; if(p.matches&&p.matches("h1,h2,h3")) return p; }
      else{ p=p.parentElement; if(!p) break; if(p.matches&&p.matches("h1,h2,h3")) return p; }
    }
    n=n.parentElement;
  }
  return null;
}

/* ==== 索引（メモ擬似エントリ注入） ==== */
function buildIndex(){
  S.index.clear(); S.tags.clear(); ID.clear();
  pages.forEach(sec=>{
    const pg=sec.dataset.page, its=heads(sec), es=[], byId=new Map();
    its.forEach(it=>{
      const body=bodyText(it.el), scope=(it.text+" "+body).trim();
      it.tags.forEach(t=>S.tags.add(t));
      const e={page:pg,id:it.id,lvl:it.l,text:it.text,scope,body,tags:[...new Set(it.tags)],parent:it.parent?.id||null,children:it.children.map(c=>c.id),el:it.el};
      es.push(e); byId.set(e.id,e); if(!ID.has(e.id)) ID.set(e.id,{text:e.text,page:pg,el:it.el});
    });
    // 親→子孫
    es.forEach(e=>{ let p=e.parent; while(p){ const pe=byId.get(p); (pe.descendants??=new Set()).add(e.id); p=pe.parent; }});
    // メモ
    $$(".note",sec).forEach(span=>{
      const up=nearestHeading(span)||sec.querySelector("h1,h2,h3"); if(!up) return;
      const parent=es.find(x=>x.el===up); if(!parent) return;
      if(!parent.tags.includes("メモ")) parent.tags.push("メモ");
      S.tags.add("メモ");
      const memoSel=span.textContent.trim(), memoBody=(span.dataset.note||"").trim();
      const memoId=parent.id+"::memo::"+Math.random().toString(36).slice(2,8);
      (parent.descendants??=new Set()).add(memoId);
      es.push({kind:"memo",page:pg,id:memoId,lvl:3,scope:(memoSel+" "+memoBody).slice(0,400),
        text:memoSel||"（メモ）", body:memoBody, sel:memoSel, tags:["メモ"], parent:parent.id, children:[], el:up, descendants:new Set()});
    });
    S.index.set(pg,es);
  });
  ALL=[...S.index.get("info")||[],...S.index.get("main")||[],...S.index.get("etc")||[]];
}

/* ==== 目次 ==== */
function buildTOC(){
  const pcol=$("#tocPages"); pcol.innerHTML="";
  ["info","main","etc"].forEach(n=>{const b=document.createElement("button"); b.textContent=n; b.setAttribute("aria-current",S.page===n&&"page"); b.onclick=()=>{switchPage(n); setOpen(toc,true)}; pcol.appendChild(b);});
  const bm=document.createElement("button"); bm.textContent="memo"; bm.onclick=()=>{ renderMemoTOC(); setOpen(toc,true); }; pcol.appendChild(bm);
  renderTree();
}
function renderTree(){
  const tree=$("#tocTree"); tree.innerHTML="";
  const sec=pages.find(p=>p.dataset.page===S.page), its=heads(sec), roots=its.filter(x=>x.l===1), open=new Set();
  const row=(it,isOpen)=>{
    const d=document.createElement("div"); d.className="row";
    const tw=document.createElement("div"); tw.className="tw";
    if(it.children.length){ tw.textContent=isOpen?"▼":"▶"; tw.onclick=()=>{open.has(it)?open.delete(it):open.add(it); render();}; } else { tw.textContent="•"; tw.classList.add("off"); }
    const j=document.createElement("div"); j.textContent=it.text; j.className=it.l===2?"lvl2":it.l===3?"lvl3":"";
    j.onclick=()=>{ it.el.scrollIntoView({block:"start",behavior:"smooth"}); if(MOBILE()) toc.classList.remove("open"); };
    d.append(tw,j); return d;
  };
  const render=()=>{ tree.innerHTML=""; roots.forEach(h1=>{ const o1=open.has(h1); tree.appendChild(row(h1,o1)); if(o1) h1.children.forEach(h2=>{ const o2=open.has(h2); tree.appendChild(row(h2,o2)); if(o2) h2.children.forEach(h3=>tree.appendChild(row(h3,false))); }); }); };
  render();
}
function renderMemoTOC(){
  const tree=$("#tocTree"); tree.innerHTML="";
  const row=document.createElement("div"); row.className="row"; row.innerHTML='<div class="tw off">•</div><div>全メモを削除</div>';
  row.onclick=()=>{ if(confirm("全メモを削除します。よろしいですか？")){ clearAllNotes(); buildIndex(); buildChips(); search(); renderTree(); alert("削除しました"); } };
  tree.appendChild(row);
}

/* ==== 検索（AND、同階層本文、表示順：info→main→etc→見出しレベル） ==== */
const q=$("#q"); let composing=false; const debounce=(f,w=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),w)}};
q.addEventListener("compositionstart",()=>composing=true);
q.addEventListener("compositionend",()=>{composing=false; search();});
q.addEventListener("input",()=>{ if(!composing) debounce(search,250)(); });
q.addEventListener("focus", clearHL);
function words(s){return (s||"").replace(/[　]/g," ").trim().split(/\s+/).filter(Boolean).map(w=>w.toLowerCase());}
function buildChips(){
  const wrap=$("#chips"); wrap.innerHTML=""; const tags=new Set(S.tags); tags.add("メモ");
  ["all",...Array.from(tags).sort((a,b)=>a.localeCompare(b,"ja"))].forEach(n=>{const b=document.createElement("button"); b.className="chip"+(n==="all"?" on":""); b.textContent=n; b.dataset.v=n; b.onclick=()=>{$$(".chip",wrap).forEach(c=>c.classList.toggle("on",c===b)); search();}; wrap.appendChild(b);});
}
const pageOrder = new Map([["info",0],["main",1],["etc",2]]);
function search(){
  const ws=words(q.value), tag=($(".chip.on")?.dataset.v)||"all", cont=$("#res"); cont.innerHTML="";
  if(tag==="all" && ws.length===0){
    const list=[...(S.index.get("info")||[]),...(S.index.get("main")||[]),...(S.index.get("etc")||[])]
      .filter(e=>!(e.kind==="memo"));
    return render(list,[],true);
  }
  const hits=ALL.filter(e=>{
    const ok=ws.every(w=> (e.scope||"").toLowerCase().includes(w));
    const tagOk=(tag==="all")||e.tags?.includes(tag)||(tag==="メモ"&&e.tags?.includes("メモ"));
    return ok&&tagOk;
  });
  const idset=new Set(hits.map(h=>h.id));
  const filtered=hits.filter(e=>{ const d=e.descendants||new Set(); for(const c of d) if(idset.has(c)) return false; return true; });
  render(filtered,ws,false);
}
function render(list,ws,preserve){
  const cont=$("#res");
  const arr = preserve ? list : list.slice().sort((a,b)=>{
    const po=(pageOrder.get(a.page)??9)-(pageOrder.get(b.page)??9);
    if(po!==0) return po;
    return a.lvl-b.lvl;
  });
  arr.forEach(e=>{
    const card=document.createElement("div"); card.className="card";
    const meta=document.createElement("div"); meta.className="meta";
    const bc=document.createElement("div"); bc.textContent=crumb(e);
    const jb=document.createElement("button"); jb.textContent="ジャンプ"; jb.className="btn"; jb.onclick=(ev)=>{ev.stopPropagation(); jump(e,ws);};
    meta.append(bc,jb);
    const ttl=document.createElement("div"); ttl.className="title";
    const content=document.createElement("div"); content.className="content";
    const [head,tail]=headTail((e.kind==="memo"?(e.body||""):(e.body||e.scope)),30);
    if(e.kind==="memo"){ ttl.textContent = e.sel || "（メモ）"; } else { ttl.textContent = e.text; }
    const prev=document.createElement("span"); prev.className="preview"; prev.textContent=head||"";
    const dots=document.createElement("span"); dots.className="dots"; dots.textContent=tail?"…":"";
    const contSpan=document.createElement("span"); contSpan.className="cont"; contSpan.textContent=tail||"";
    content.append(prev,dots,contSpan);
    card.onclick=()=>card.classList.toggle("open");
    card.append(meta,ttl,content); cont.appendChild(card);
  });
}
function headTail(s,n){if(!s)return["",""];const a=Array.from(s);return[a.slice(0,n).join(""),a.slice(n).join("")];}
function crumb(e){
  const es=S.index.get(e.page)||[]; if(e.lvl===1) return e.page;
  if(e.lvl===2){const p=es.find(x=>x.id===e.parent); return e.page+" ＞ "+(p?.text||"");}
  const p=es.find(x=>x.id===e.parent), p2=es.find(x=>x.id===p?.parent);
  return e.page+" ＞ "+(p2?.text||"")+" ＞ "+(p?.text||"");
}
function clearHL(){ $$(".hl-tmp",sc).forEach(m=>m.replaceWith(document.createTextNode(m.textContent))); }
function highlight(el,ws){
  const walker=document.createTreeWalker(el.closest("section")||sc,NodeFilter.SHOW_TEXT,{acceptNode(n){
    if(!n.nodeValue.trim())return NodeFilter.FILTER_REJECT;
    const p=n.parentElement; if(p&&(p.closest("pre,code,.code")||p.classList.contains("note"))) return NodeFilter.FILTER_REJECT;
    return NodeFilter.FILTER_ACCEPT;
  }});
  const re=new RegExp("("+ws.map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")+")","ig");
  const targets=[]; while(walker.nextNode()){const n=walker.currentNode; if(re.test(n.nodeValue)) targets.push(n);}
  targets.forEach(n=>{
    const parts=n.nodeValue.split(re), f=document.createDocumentFragment();
    parts.forEach(t=>{ if(!t) return; if(ws.some(w=>t.toLowerCase()===w.toLowerCase())){ const m=document.createElement("mark"); m.className="hl-tmp"; m.textContent=t; f.appendChild(m);} else f.appendChild(document.createTextNode(t));});
    n.parentNode.replaceChild(f,n);
  });
}
function jump(e,ws){
  const go=()=>{ e.el.scrollIntoView({block:"start",behavior:"smooth"}); clearHL(); if(ws.length){ highlight(e.el,ws); ($(".hl-tmp")||e.el).scrollIntoView({block:"center",behavior:"smooth"}); } if(MOBILE()){ setOpen(sea,false);} };
  if(e.page!==S.page){ switchPage(e.page); requestAnimationFrame(()=>{ const sec=pages.find(p=>p.dataset.page===e.page); e.el=sec.querySelector('[data-id="'+CSS.escape(e.id)+'"],#'+CSS.escape(e.id))||e.el; go(); }); } else go();
}

/* ==== コードコピー（ボタン表記：copy） ==== */
document.addEventListener("click",async e=>{
  const b=e.target.closest(".code .copy"); if(!b) return;
  const code=b.parentElement.querySelector("code").innerText;
  try{ await navigator.clipboard.writeText(code); b.classList.add("done"); b.textContent="copied ✓"; setTimeout(()=>{b.classList.remove("done"); b.textContent="copy";},900);}catch{ alert("copy failed"); }
});

/* ==== 本文内 #id / #page:id リンク名の自動補完 ==== */
function parseHash(h){
  const raw=decodeURIComponent(h.replace(/^#/,""));
  if(!raw) return {id:"",page:null};
  const m=raw.match(/^([a-zA-Z0-9_-]+):(.*)$/);
  return m? {page:m[1], id:m[2]} : {page:null, id:raw};
}
function linkNames(){
  $$('a[href^="#"]',sc).forEach(a=>{
    const {id}=parseHash(a.getAttribute("href"));
    const ent=ID.get(id);
    if(ent){ a.textContent=ent.text; a.title=ent.text; a.addEventListener("click",ev=>{ev.preventDefault(); location.hash="#"+encodeURIComponent(ent.page+":"+id);},{once:true}); }
  });
}
addEventListener("hashchange",()=>{
  const {id,page}=parseHash(location.hash);
  if(!id) return;
  const ent=ID.get(id); if(!ent) return;
  const targetPage = page || ent.page;
  const act=()=>{ const sec=pages.find(p=>p.dataset.page===targetPage);
    (sec.querySelector('[data-id="'+CSS.escape(id)+'"],#'+CSS.escape(id))||ent.el).scrollIntoView({block:"start",behavior:"smooth"}); };
  if(targetPage!==S.page){ switchPage(targetPage); requestAnimationFrame(act);} else act();
});

/* ==== メモ（見出しも可） ==== */
const fab=$("#fab"); let sel=null, popRef=null;
function blockOf(n){return (n.nodeType===1?n:n.parentElement)?.closest("h1,h2,h3,p,li,blockquote,pre,dd,td,div");}
function getRange(){
  const s=getSelection(); if(!s||s.isCollapsed) return null;
  const r=s.getRangeAt(0).cloneRange(); const b=blockOf(r.startContainer), c=blockOf(r.endContainer);
  if(!b||!c||b!==c) return null; if(b.closest(".note")||c.closest(".note")) return null;
  if(!sc.contains(b)||r.toString().trim().length>300) return null; return r;
}
function placeFab(el, rect){
  const vp=vport(), pad=8, ew=el.offsetWidth||40, eh=el.offsetHeight||40;
  let x = rect.left + rect.width/2 + (scrollX||0) - ew/2;
  let y = rect.top  + (scrollY||0) - 48;
  x = clamp(x, vp.x+pad, vp.x+vp.w-ew-pad);
  y = clamp(y, vp.y+pad, vp.y+vp.h-eh-pad);
  el.style.left=x+"px"; el.style.top=y+"px";
}
function showFab(){ sel=getRange(); if(!sel){ fab.classList.remove("show"); return; } const r=sel.getBoundingClientRect(); fab.classList.add("show"); placeFab(fab, r); }
sc.addEventListener("mouseup",()=>setTimeout(showFab,0));
sc.addEventListener("touchend",()=>setTimeout(showFab,0));
addEventListener("scroll",()=>fab.classList.remove("show"),{passive:true});
fab.onclick=()=>{ if(!sel) return; openNote({range:sel}); fab.classList.remove("show"); getSelection().removeAllRanges(); };

function placePopup(el, anchorRect, pref="below"){
  const pad=8, vp=vport();
  const ew=el.offsetWidth||320, eh=el.offsetHeight||200;
  const ax=anchorRect.left + anchorRect.width/2 + (scrollX||0);
  const ay=anchorRect.top  + (scrollY||0);
  let x = ax - ew/2;
  let y = (pref==="below"? ay + anchorRect.height + 10 : ay - eh - 10);
  const tooLow  = y + eh > vp.y + vp.h - pad;
  const tooHigh = y < vp.y + pad;
  if(pref==="below" && tooLow)  y = ay - eh - 10;
  if(pref==="above" && tooHigh) y = ay + anchorRect.height + 10;
  if(y + eh > vp.y + vp.h - pad || y < vp.y + pad) y = vp.y + (vp.h - eh)/2;
  x = clamp(x, vp.x+pad, vp.x+vp.w-ew-pad);
  el.style.left=x+"px"; el.style.top=y+"px";
}

function openNote({range,node}){
  closePop();
  const pop=document.createElement("div"); pop.className="pop"; popRef=pop;
  const head=document.createElement("h4"); head.textContent=node?"メモを編集":"メモを追加";
  const prev=document.createElement("div"); prev.style="font-size:12px;color:#666"; prev.textContent="選択："+(node?node.textContent.slice(0,30):range.toString().slice(0,30));
  const ta=document.createElement("textarea"); if(node) ta.value=node.dataset.note||"";
  const act=document.createElement("div"); act.className="actions";
  const sv=document.createElement("button"); sv.className="btn primary"; sv.textContent="保存";
  const cn=document.createElement("button"); cn.className="btn"; cn.textContent="やめる";
  act.append(sv,cn);
  if(node){ const del=document.createElement("button"); del.className="btn danger"; del.textContent="削除"; del.style.position="absolute"; del.style.right="10px"; del.style.top="10px";
    del.onclick=()=>{ unwrap(node); closePop(); persistNotes(); buildIndex(); buildChips(); search(); };
    pop.append(del);
  }
  pop.append(head,prev,ta,act); document.body.appendChild(pop);
  const rect=(range?range.getBoundingClientRect():node.getBoundingClientRect());
  requestAnimationFrame(()=>{ placePopup(pop, rect, "below"); });
  const off=(ev)=>{ if(pop && !pop.contains(ev.target)) closePop(); };
  setTimeout(()=>document.addEventListener("mousedown",off,{once:true}),0);

  cn.onclick=closePop;
  sv.onclick=()=>{
    if(node){ node.dataset.note=ta.value.trim(); closePop(); persistNotes(); buildIndex(); buildChips(); search(); }
    else{
      const span=document.createElement("span"); span.className="note"; span.dataset.note=ta.value.trim();
      try{ range.surroundContents(span);}catch{ const frag=range.extractContents(); span.appendChild(frag); range.insertNode(span); }
      span.addEventListener("click",e=>{e.stopPropagation(); openNote({node:span});});
      closePop(); persistNotes(); buildIndex(); buildChips(); search();
    }
  };
}
function closePop(){ if(popRef){ popRef.remove(); popRef=null; } }
function unwrap(span){ const p=span.parentNode; while(span.firstChild) p.insertBefore(span.firstChild,span); p.removeChild(span); }
function hookNotes(){ $$(".note",sc).forEach(n=>{ if(n._hooked) return; n.addEventListener("click",e=>{e.stopPropagation(); openNote({node:n});}); n._hooked=true; }); }

/* ==== メモ保存：シリアライズ（親見出し＋ブロック番号＋オフセット） ==== */
function textBlocksUnderHeading(hEl){
  const L=hEl.tagName, arr=[];
  let n=hEl; // 見出し自身もブロックとして 0 番
  while(n && n!==hEl.parentElement){
    if(n===hEl){ arr.push(hEl); n=n.nextSibling; continue; }
    if(!n) break;
    if(n.nodeType===1){
      const tn=n.tagName;
      if((tn==="H1"&&(L==="H1"||L==="H2"||L==="H3"))||(tn==="H2"&&(L==="H2"||L==="H3"))||(tn==="H3"&&L==="H3")) break;
      if(n.matches("h1,h2,h3")) break;
      if(n.matches("h1,h2,h3,p,li,blockquote,pre,dd,td,div")) arr.push(n);
    }
    n=n.nextSibling;
  }
  return arr;
}
function globalOffsetInBlock(block,targetSpan){
  let offset=0, found=false;
  const walker=document.createTreeWalker(block,NodeFilter.SHOW_TEXT,null);
  while(walker.nextNode()){
    const t=walker.currentNode;
    if(targetSpan.contains(t)) { found=true; break; }
    else if(targetSpan.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING){ offset += t.nodeValue.length; }
  }
  if(!found){
    const selText = targetSpan.textContent;
    const pos = block.textContent.indexOf(selText);
    return pos>=0?pos:0;
  }
  const beforeWalker=document.createTreeWalker(block,NodeFilter.SHOW_TEXT,null);
  let pos=0;
  while(beforeWalker.nextNode()){
    const t=beforeWalker.currentNode;
    if(targetSpan.contains(t)) break;
    pos += t.nodeValue.length;
  }
  return pos;
}
function surroundRangeByOffsets(block,start,len){
  const walker=document.createTreeWalker(block,NodeFilter.SHOW_TEXT,null);
  let acc=0, startNode=null, startOff=0, endNode=null, endOff=0;
  while(walker.nextNode()){
    const t=walker.currentNode, L=t.nodeValue.length;
    if(startNode===null && acc+L>=start){ startNode=t; startOff=start-acc; }
    if(startNode!==null && acc+L>=start+len){ endNode=t; endOff=start+len-acc; break; }
    acc+=L;
  }
  if(!startNode) return null;
  if(!endNode){ endNode=startNode; endOff=startOff+len; }
  const r=document.createRange(); r.setStart(startNode,startOff); r.setEnd(endNode,endOff); return r;
}
function persistNotes(){
  hookNotes();
  const memos=[];
  pages.forEach(sec=>{
    const page=sec.dataset.page;
    $$(".note",sec).forEach(span=>{
      const h=nearestHeading(span); if(!h) return;
      const hid=h.dataset.id||h.id; if(!hid) return;
      const blocks=textBlocksUnderHeading(h); const blk=blockOf(span);
      const bIndex=blocks.indexOf(blk); if(bIndex<0) return;
      const start=globalOffsetInBlock(blk,span); const length=span.textContent.length;
      memos.push({page,hid,bIndex,start,length,body:span.dataset.note||"",sel:span.textContent});
    });
  });
  try{ localStorage.setItem(MEMO_KEY, JSON.stringify(memos)); }catch{}
}
function restoreNotes(){
  const raw=localStorage.getItem(MEMO_KEY); if(!raw) return;
  let memos=[]; try{ memos=JSON.parse(raw)||[]; }catch{ return; }
  memos.forEach(m=>{
    const sec=pages.find(p=>p.dataset.page===m.page); if(!sec) return;
    const h=sec.querySelector('[data-id="'+CSS.escape(m.hid)+'"],#'+CSS.escape(m.hid)); if(!h) return;
    const blocks=textBlocksUnderHeading(h); const blk=blocks[m.bIndex]; if(!blk) return;
    const r=surroundRangeByOffsets(blk,m.start,m.length); if(!r) return;
    const span=document.createElement("span"); span.className="note"; span.dataset.note=m.body;
    try{ r.surroundContents(span); }catch{ const frag=r.extractContents(); span.appendChild(frag); r.insertNode(span); }
    span.addEventListener("click",e=>{e.stopPropagation(); openNote({node:span});});
  });
}

/* ==== 全メモ削除 ==== */
function clearAllNotes(){
  pages.forEach(sec=>{ $$(".note",sec).forEach(unwrap); });
  try{ localStorage.removeItem(MEMO_KEY);}catch{}
}

/* ==== 初期化 ==== */
autoBoxCodes();            // プレーン<pre><code>→灰箱化
restoreNotes();            // メモ復元
hookNotes();               // 編集フック
buildIndex(); buildChips();
buildTOC(); search();
linkNames(); updIcon();

/* ==== ユーティリティ ==== */
function autoBoxCodes(){ $$("pre:not(.code)>code",sc).forEach(c=>{const p=c.parentElement;p.classList.add("code");const b=document.createElement("button");b.className="copy";b.textContent="copy";p.insertBefore(b,c);}); }

})();
</script>
</body>
</html>